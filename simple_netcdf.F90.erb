<% TYPE = {
     '_str' => 'character(*)',
     'i' => 'integer',
     'f' => 'real*4',
     'd' => 'real*8'
} %>
<% # The below two lines do not apply to this simple_netcdf.F90.erb file %>
<%= "!!! DO NOT EDIT THIS FILE DIRECTLY!!!" %>
<%= "!!! AUTO-GENERATED FROM simple_netcdf.F90.erb !!!" %>

! NetCDF wrapper functions to make it easier to read and write NetCDF files,
! especially CF-compliant files.  Also gives more useful error messages.
!
! TO DOCUMENT: HAVE_NETCDF4 preprocessor flag.
module SimpleNetCDF
    use netcdf
    implicit none

    ! Contains information about the NetCDF file which the SimpleNetCDF
    ! module uses for more detailed error reporting and other API
    ! simplification. You will not normally need to access these values
    ! directly.
    type SNCFile
        integer :: ncid
        character(512) :: name
        integer :: ndims, cfdimids(5)
        character(32) :: z_name ! name of the vertical dimension
    end type SNCFile

    ! Keeps information about the NetCDF variable for the SimpleNetCDF
    ! module to give more detailed error reports.  You will not normally need
    ! to access the id or name members.  To make your life easier, you should
    ! access the following members:
    !
    ! ndims: The variable's number of dimensions.
    ! dims: The size of each dimension.  Only dims(1:var%ndims) are valid.
    type SNCVar
        integer :: id
        character(128) :: name
        integer :: ndims, dims(6)
    end type SNCVar

    ! Returns the size of the given dimension.  It has two forms, one where
    ! you lookup the dimension <a href="#mod_SimpleNetCDF_fun_snc_get_dim_by_id">by id</a>
    ! and the other <a href="#mod_SimpleNetCDF_snc_get_dim_by_name">by name</a>.
    ! You can get the dimension with snc_get_dimid; you always have to know
    ! the dimension's name.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_get_dim
        module procedure snc_get_dim_by_id, snc_get_dim_by_name
    end interface snc_get_dim

    ! Write coordinate variables to a CF-compliant NetCDF file.
    !
    ! file: an SNCFile type returned by snc_create.
    ! lon: an array of longitude values for the grid points.
    ! lat: an array of latitude values for the grid points.
    ! z: an array of vertical coordinates for the grid points.  Only present
    !   in 3d files.
    ! time: an array of time values for each timestep in the file.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_cf_write_coords
        module procedure snc_cf_write_coords2f, snc_cf_write_coords2d
        module procedure snc_cf_write_coords3f, snc_cf_write_coords3d
    end interface snc_cf_write_coords

    ! Open a NetCDF file and read the given variable in one shot.
    !
    ! filename: the name of the NetCDF file to open.
    ! varname: the name of the variable in the file to read.
    ! data: a pointer to an array with the same type as the variable in
    !   the file, and with the same number of dimensions or one less dimension
    !   if reading one timestep.
    ! timestep: optional.  Specify the timestep to read, subsetting the variable
    !   along the slowest-changing dimension.
    ! units: optional.  Returns the units attribute for the variable.  Make sure
    !   the string is big enough to hold the units value.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_open_var
        module procedure snc_open_var1i, snc_open_var1f, snc_open_var1d
        module procedure snc_open_var2i, snc_open_var2f, snc_open_var2d
        module procedure snc_open_var3i, snc_open_var3f, snc_open_var3d
        module procedure snc_open_var4i, snc_open_var4f, snc_open_var4d
    end interface snc_open_var

    ! Read 1-4 dimensional arrays of type integer, float (real*4)
    ! or double (real*8).
    !
    ! file: the SNCFile type you want to read from.
    ! var: the SNCVar type you want to read.
    ! data: an unallocated array pointer to read the data into.  Must be
    !   unassociated and be declared with the right number of dimensions.
    ! timestep: optional. The timestep to read.  This subsets the variable,
    !   requiring an array with one less dimension than the variable has in
    !   the NetCDF file.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_read
        module procedure snc_read1i, snc_read1f, snc_read1d
        module procedure snc_read2i, snc_read2f, snc_read2d
        module procedure snc_read3i, snc_read3f, snc_read3d
        module procedure snc_read4i, snc_read4f, snc_read4d
    end interface snc_read

    ! Write 1-4 dimensional arrays of type integer, float (real*4) or double
    ! (real*8).
    !
    ! file: the SNCFile type you want to write into.
    ! var: the SNCVar type you want to write.
    ! data: an array of the type and dimension number matching the variable's
    !   definition, often given in the call to snc_def_var or snc_cf_def_var.
    ! timestep: optional. Give this argument if you wish to write only a single
    !   timestep's worth of data at this time.  In that case, your data array
    !   will have one less dimension than normal.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_write
        module procedure snc_write1i, snc_write1f, snc_write1d
        module procedure snc_write2i, snc_write2f, snc_write2d
        module procedure snc_write3i, snc_write3f, snc_write3d
        module procedure snc_write4i, snc_write4f, snc_write4d
    end interface snc_write

    ! Read a variable's attribute from the NetCDF file.
    !
    ! file: the SNCFile type to read the attribute from.
    ! var: the SNCVar type to read the attribute from.
    ! attname: the name of the attribute.
    ! attvalue: the variable to read the attribute's value into.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_get_att
        module procedure snc_get_att_str, snc_get_atti, snc_get_attf, snc_get_attd
    end interface snc_get_att

    ! Read a global attribute from the NetCDF file.
    !
    ! file: the SNCFile type to read the attribute from.
    ! attname: the name of the attribute.
    ! attvalue: the variable to read the attribute's value into.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_get_global_att
        module procedure snc_get_gatt_str, snc_get_gatti, snc_get_gattf, snc_get_gattd
    end interface snc_get_global_att

    ! Write an attribute to a variable in the NetCDF file.
    !
    ! file: the SNCFile type to write the attribute to.
    ! var: The SNCVar type to write the attribute to.
    ! attname: the name of the attribute.
    ! attvalue: the attribute's value.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_put_att
        module procedure snc_put_att_str, snc_put_atti, snc_put_attf, snc_put_attd
    end interface snc_put_att

    ! Write a global attribute to the NetCDF file.
    !
    ! file: the SNCFile type to write the attribute to.
    ! attname: the name of the attribute.
    ! attvalue: the attribute's value.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    interface snc_put_global_att
        module procedure snc_put_gatt_str, snc_put_gatti, snc_put_gattf, snc_put_gattd
    end interface snc_put_global_att

    ! Used with snc_def_dim to specify the unlimited dimension (usually time).
    integer, parameter :: SNC_UNLIMITED = NF90_UNLIMITED

    ! Types supported by the SimpleNetCDF module.
    integer, parameter :: SNC_INT       = NF90_INT
    integer, parameter :: SNC_FLOAT     = NF90_FLOAT
    integer, parameter :: SNC_DOUBLE    = NF90_DOUBLE

    integer, parameter, private :: SNC_READ_MODE = NF90_SHARE
    integer, parameter, private :: SNC_WRITE_MODE = NF90_NOCLOBBER
    integer, parameter, private :: SNC_OVERWRITE_MODE = NF90_CLOBBER
#ifdef HAVE_NETCDF4
    integer, parameter, private :: SNC_DEFAULT_DEFLATE = 6
#endif

    ! Common calendars
    character(16), parameter :: SNC_STANDARD_CAL = "standard" ! udunits' mixed gregorian/julian calendar
    character(16), parameter :: SNC_NOLEAP = "noleap" ! all years are 365 days long

contains

    ! CF COMPLIANCY SECTION ---


    ! Create a new CF-compliant gridded data file.
    !
    ! filename: the path name of the NetCDF file to create.
    ! lon_size: the number of longitude grid points.
    ! lat_size: the number of grid points along the latitude (Y)
    ! time_units: A UDUNITS-compatible time format like:
    !       seconds since 2012-02-01 03:05:22.0 -7:00
    !   so we have a time unit (seconds) since an absolute time, namely 3
    !   hours, 5 minutes and 22 seconds into February 1 2012, with timezone
    !   offset of -7 hours (Mountain Standard Time).  Often you will want
    !   to start at the beginning of a particular day and use UTC time
    !   (no timezone offset), so you can use a simpler format like:
    !       hours since 2012-01-01
    !   Note that the time unit can be anything allowed by the UDUNITS
    !   package, but most commonly this will be seconds, hours or days.
    !   Time units of months or years can cause problems because both years
    !   and months are of varying lengths, so their use is discouraged.
    ! calendar: specifies the type of calendar so that dates can be properly
    !   calculated.  Normally you will want to use SNC_STANDARD_CAL if you
    !   are dealing with the standard western (gregorian) calendar for,
    !   e.g. satellite data.  If you are dealing with a gregorian calendar
    !   without leap years (every year is 365 days long), use SNC_NOLEAP.
    !   See the [CF Docs](http://cf-pcmdi.llnl.gov/) for other calendars.
    ! title: optional. "A succinct description of what is in the dataset."
    !   e.g. "CO2 fluxes".
    ! source: optional. "The method of production of the original data. If it
    !   was model-generated, source should name the model and its version, as
    !   specifically as could be useful.  If it is observational, source
    !   should characterize it..." e.g. "radiosonde" or "SiB 3".
    ! overwrite: optional. If true, will allow existing files of the given
    !   filename to be overwritten.
    ! nc3_file: optional. If true, write a NetCDF version 3 file.  This older
    !   file format does not support compression or parallel I/O, so this
    !   option is most useful for compatibility with older software.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    !
    ! Other attributes you might consider adding with snc_put_att():
    !
    ! - comment: "Miscellaneous information about the data or methods used
    !     to produce it."
    ! - history: A list of programs that modified this file, what and when
    !     they did it.
    ! - institution: The name of the facility where the data was created.
    function snc_cf_grid_create(filename, lon_size, lat_size, time_units, &
        calendar, title, source, overwrite, nc3_file, src_file, src_line)
        character(*), intent(in) :: filename
        integer, intent(in) :: lat_size, lon_size
        character(*), intent(in) :: time_units
        character(*), intent(in) :: calendar
        character(*), intent(in), optional :: title, source
        logical, intent(in), optional :: overwrite, nc3_file
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCFile) :: snc_cf_grid_create, file
        type(SNCVar) :: var, global_var
        integer :: lat_id, lon_id, time_id

        file = snc_create(filename, overwrite, nc3_file, src_file, src_line)

        ! dimensions
        lat_id = snc_def_dim(file, "lat", lat_size, src_file, src_line)
        lon_id = snc_def_dim(file, "lon", lon_size, src_file, src_line)
        time_id = snc_def_dim(file, "time", SNC_UNLIMITED, src_file, src_line)

        ! coordinate variables
        var = snc_cf_def_var(file, "lon", "longitude", SNC_FLOAT, "degrees_east", &
            (/lon_id/), standard_name = "longitude", &
            src_file = src_file, src_line = src_line)
        call snc_put_att(file, var, "axis", "X", src_file, src_line)

        var = snc_cf_def_var(file, "lat", "latitude", SNC_FLOAT, "degrees_north", &
            (/lat_id/), standard_name = "latitude", &
            src_file = src_file, src_line = src_line)
        call snc_put_att(file, var, "axis", "Y", src_file, src_line)

        var = snc_cf_def_var(file, "time", "time", SNC_FLOAT, time_units, (/time_id/), &
            src_file = src_file, src_line = src_line)
        call snc_put_att(file, var, "axis", "T", src_file, src_line)
        call snc_put_att(file, var, "calendar", calendar, src_file, src_line)

        ! global attributes
        global_var%id = NF90_GLOBAL
        global_var%name = "-global-"

        call snc_put_att(file, global_var, "Conventions", "CF-1.6", src_file, src_line)
        if (present(title)) then
            call snc_put_att(file, global_var, "title", title, src_file, src_line)
        end if
        if (present(source)) then
            call snc_put_att(file, global_var, "source", source, src_file, src_line)
        end if

        ! leave in define mode so user can do whatever else they need to
        file%ndims = 3
        file%cfdimids(1) = lon_id
        file%cfdimids(2) = lat_id
        file%cfdimids(3) = time_id
        snc_cf_grid_create = file
    end function snc_cf_grid_create

    ! Define a CF-compliant vertical coordinate for a NetCDF file.
    !
    ! file: the SNCFile returned by snc_cf_grid_create().
    ! z_size: the size of the vertical dimension.
    ! name: the name of the vertical dimension and coordinate variable.
    ! long_name: the long name for the vertical coordinate variable.
    ! units: the units for the vertical coordinate variable.
    ! positive: the direction of positive values, either "up" or "down".
    ! standard_name: optional. a name from
    !   http://cf-pcmdi.llnl.gov/documents/cf-standard-names/
    !   matching this variable.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    subroutine snc_cf_grid_vertical(file, z_size, name, long_name, units, &
        positive, standard_name, src_file, src_line)

        type(SNCFile), intent(inout) :: file
        integer, intent(in) :: z_size
        character(*), intent(in) :: name, long_name, units, positive
        character(*), intent(in), optional :: standard_name
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        integer :: z_id
        type(SNCVar) :: var

        z_id = snc_def_dim(file, name, z_size, src_file, src_line)

        var = snc_cf_def_var(file, name, long_name, SNC_FLOAT, units, &
            (/z_id/), standard_name, src_file = src_file, src_line = src_line)
        call snc_put_att(file, var, "axis", "Z", src_file, src_line)
        call snc_put_att(file, var, "positive", positive, src_file, src_line)

        if (file%ndims == 3) then
            file%ndims = 4
            file%cfdimids(4) = file%cfdimids(3) ! move time id to end
            file%cfdimids(3) = z_id
        else
            if (present(src_file) .and. present(src_line)) then
                write(*, "(A,' line',I5,': ',A)") src_file, src_line, &
                    "in snc_cf_grid_vertical() - file%ndims /= 3"
            else
                write(*, "(A)") "in snc_cf_grid_vertical() - file%ndims /= 3"

            end if
            stop
        end if

        file%z_name = name
    end subroutine snc_cf_grid_vertical

    ! Define a CF-compliant NetCDF variable.
    !
    ! file: the SNCFile returned from snc_cf_grid_create().
    ! varname: the name of the variable.
    ! long_name: a more descriptive name for the variable.
    ! type: a type for the variable; usually one of SNC_INT, SNC_FLOAT or
    !   SNC_DOUBLE.
    ! units: the units for the variable, compatible with UDUNITS.
    ! dimids: optional.  An array of dimension IDs.  The default is to use
    !   the full (time, lat, lon) or (time,<vert>,lat,lon) dimensions
    !   defined with snc_cf_grid_create() and snc_cf_grid_vertical().
    ! standard_name:  optional. a name from
    !   http://cf-pcmdi.llnl.gov/documents/cf-standard-names/
    !   matching this variable.
    ! missing_value: optional. A value used for missing data in the variable.
    !   NOT FOR COORDINATE VARIABLES.
    ! fill_value: optional. A value for missing or undefined data.
    !   NOT FOR COORDINATE VARIABLES.
    ! valid_min: optional. Smallest valid value in the variable.
    ! valid_max: optional. Largest valid value in the variable.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_cf_def_var(file, varname, long_name, type, units, dimids, &
        standard_name, missing_value, fill_value, valid_min, valid_max, &
        src_file, src_line)

        type(SNCFile), intent(in) :: file
        character(*), intent(in) :: varname, long_name, units
        integer, intent(in) :: type
        integer, intent(in), optional :: dimids(:)
        character(*), intent(in), optional :: standard_name
        real, intent(in), optional :: missing_value
        character(*), intent(in), optional :: fill_value, valid_min, valid_max
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCVar) :: var, snc_cf_def_var

        if (present(dimids)) then
            var = snc_def_var(file, varname, type, dimids, &
                src_file = src_file, src_line = src_line)
        else
            var = snc_def_var(file, varname, type, file%cfdimids(1:file%ndims), &
                src_file = src_file, src_line = src_line)
        end if

        call snc_put_att(file, var, "long_name", long_name, src_file, src_line)
        call snc_put_att(file, var, "units", units, src_file, src_line)

        if (present(standard_name)) then
            call snc_put_att(file, var, "standard_name", standard_name, src_file, src_line)
        end if
        if (present(missing_value)) then
            if (type == SNC_FLOAT .or. type == SNC_DOUBLE) then
                call snc_put_att(file, var, "missing_value", missing_value, &
                    src_file, src_line)
            else
                call snc_put_att(file, var, "missing_value", int(missing_value), &
                    src_file, src_line)
            end if
        end if
        if (present(fill_value)) then
            call snc_put_att(file, var, "_FillValue", fill_value, src_file, src_line)
        end if
        if (present(valid_min)) then
            call snc_put_att(file, var, "valid_min", valid_min, src_file, src_line)
        end if
        if (present(valid_max)) then
            call snc_put_att(file, var, "valid_max", valid_max, src_file, src_line)
        end if

        snc_cf_def_var = var
    end function snc_cf_def_var

    ! Write the coordinate variables to a CF-compliant NetCDF file.

%   'fd'.each_char do |t|
    ! :nodoc:
    subroutine snc_cf_write_coords2<%= t %>(file, lon, lat, time, src_file, src_line)
        type(SNCFile), intent(in) :: file
        <%= TYPE[t] %>, intent(in), dimension(:) :: lon, lat, time
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCVar) :: var

        var = snc_inq_var(file, "lat", src_file = src_file, src_line = src_line)
        call snc_write(file, var, lat, src_file = src_file, src_line = src_line)

        var = snc_inq_var(file, "lon", src_file = src_file, src_line = src_line)
        call snc_write(file, var, lon, src_file = src_file, src_line = src_line)

        var = snc_inq_var(file, "time", src_file = src_file, src_line = src_line)
        call snc_write(file, var, time, src_file = src_file, src_line = src_line)
    end subroutine snc_cf_write_coords2<%= t %>


    ! :nodoc:
    subroutine snc_cf_write_coords3<%= t %>(file, lon, lat, z, time, src_file, src_line)
        type(SNCFile), intent(in) :: file
        <%= TYPE[t] %>, intent(in), dimension(:) :: lon, lat, z, time
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCVar) :: z_var

        call snc_cf_write_coords(file, lon, lat, time, src_file, src_line)

        z_var = snc_inq_var(file, file%z_name, src_file = src_file, src_line = src_line)
        call snc_write(file, z_var, z, src_file = src_file, src_line = src_line)
    end subroutine snc_cf_write_coords3<%= t %>


% end


    ! OPEN FILE AND READ VARIABLE ---

% (1..4).each do |n|
%   "ifd".each_char do |t|
    ! :nodoc:
    subroutine snc_open_var<%= n %><%= t %>(filename, varname, data, timestep, &
        units, src_file, src_line)
        character(*), intent(in) :: filename, varname
        <%= TYPE[t] %>, pointer :: data(<%= ([':'] * n).join(',') %>)
        integer, intent(in), optional :: timestep
        character(*), intent(out), optional :: units
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCFile) :: file
        type(SNCVar) :: var

        file = snc_open(filename, src_file = src_file, src_line = src_line)
        var = snc_inq_var(file, varname, units, src_file = src_file, src_line = src_line)
        call snc_read(file, var, data, timestep, src_file = src_file, src_line = src_line)
        call snc_close(file, src_file = src_file, src_line = src_line)
    end subroutine snc_open_var<%= n %><%= t %>


%   end

% end



    ! OPEN SECTION ---


    ! Open a NetCDF file for reading.
    !
    ! filename: the path to the file you wish to open.  Must already exist.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_open(filename, src_file, src_line)
        character(*), intent(in) :: filename
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCFile) :: snc_open
        character(530) :: err_msg

        write(err_msg, "('opening ',A)") trim(filename)
        call snc_handle_error(nf90_open(filename, SNC_READ_MODE, snc_open%ncid), &
            err_msg, src_file, src_line)
        snc_open%name = filename
    end function snc_open

    ! Open a NetCDF file for writing.
    !
    ! filename: the path to the file to create.  It should end in ".nc".
    ! overwrite: optional. If true, will allow existing files of the given
    !   filename to be overwritten.
    ! nc3_file: optional. If true, write a NetCDF version 3 file.  This older
    !   file format does not support compression or parallel I/O, so this
    !   option is most useful for compatibility with older software.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_create(filename, overwrite, nc3_file, src_file, src_line)
        character(*), intent(in) :: filename
        logical, intent(in), optional :: overwrite, nc3_file
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCFile) :: snc_create
        character(530) :: err_msg
        integer :: mode

        if (present(overwrite) .and. overwrite) then
            mode = SNC_OVERWRITE_MODE
        else
            mode = SNC_WRITE_MODE
        end if

#ifdef HAVE_NETCDF4
        if (.not. present(nc3_file) .or. .not. nc3_file) then
            mode = IOR(mode, NF90_HDF5) ! use an HDF5 format file
        end if
#else
        if (present(nc3_file) .and. .not. nc3_file) then
            if (present(src_file) .and. present(src_line)) then
                print "(A,' line',I5,': in snc_create(): Warning: nc3_file must not be .false. for file ''',A,'''')", &
                    trim(src_file), src_line, trim(filename)
            else
                print "('in snc_create(): Warning: nc3_file must not be .false. for file ''',A,'''')", trim(filename)
            end if
        end if
#endif

        write(err_msg, "('creating ',A)") trim(filename)
        call snc_handle_error(nf90_create(filename, mode, snc_create%ncid), &
            err_msg, src_file, src_line)
        snc_create%name = filename
    end function snc_create


    ! DIMENSIONS SECTION ---


    ! Returns the NetCDF ID for the given dimension name.
    !
    ! file: the SNCFile type to get the dimension id from.
    ! dimname: the name of the dimension to look up.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_get_dimid(file, dimname, src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in) :: dimname
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        integer :: snc_get_dimid
        character(700) :: err_msg

        write(err_msg, "('getting id for dimension ''',A,''' in ',A)") &
            trim(dimname), trim(file%name)
        call snc_handle_error(nf90_inq_dimid(file%ncid, dimname, snc_get_dimid), &
            err_msg, src_file, src_line)
    end function snc_get_dimid

    ! Returns the size of the dimension by ID.
    !
    ! file: the SNCFile type to get the dimension size from.
    ! dimid: the ID number of the dimension to look up.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_get_dim_by_id(file, dimid, src_file, src_line)
        type(SNCFile), intent(in) :: file
        integer, intent(in) :: dimid
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        integer :: snc_get_dim_by_id
        character(128) :: dimname
        character(700) :: err_msg

        write(err_msg, "('getting name for dimid ',I5,'in ',A)") &
            dimid, trim(file%name)
        call snc_handle_error(nf90_inquire_dimension(file%ncid, dimid, dimname), &
            err_msg, src_file, src_line)

        write(err_msg, "('getting length for dimension ''',A,''' in ',A)") &
            trim(dimname), trim(file%name)
        call snc_handle_error(nf90_inquire_dimension(file%ncid, dimid, len = snc_get_dim_by_id), &
            err_msg, src_file, src_line)
    end function snc_get_dim_by_id

    ! Returns the size of the named dimension.
    !
    ! file: the SNCFile type to get the dimension size from.
    ! dimname: the name of the dimension to look up.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_get_dim_by_name(file, dimname, src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in) :: dimname
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        integer :: snc_get_dim_by_name
        integer :: dimid
        character(700) :: err_msg

        dimid = snc_get_dimid(file, dimname, src_file, src_line)

        write(err_msg, "('getting length for dimension ''',A,''' in ',A)") &
            trim(dimname), trim(file%name)
        call snc_handle_error(nf90_inquire_dimension(file%ncid, dimid, len = snc_get_dim_by_name), &
            err_msg, src_file, src_line)
    end function snc_get_dim_by_name

    ! Defines a dimension with the given name and size, then returns its id
    ! for use in defining variables later.
    !
    ! file: the SNCFile type to define the dimension in.
    ! dimname: the name for the new dimension.
    ! dimsize: the length of the new dimension.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_def_dim(file, dimname, dimsize, src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in) :: dimname
        integer, intent(in) :: dimsize
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        integer :: snc_def_dim
        integer :: dimid
        character(700) :: err_msg

        write(err_msg, "('defining dimension ''',A,''' = ',I6,'in ',A)") &
            trim(dimname), dimsize, trim(file%name)
        call snc_handle_error(nf90_def_dim(file%ncid, dimname, dimsize, dimid), &
            err_msg, src_file, src_line)
        snc_def_dim = dimid
    end function snc_def_dim



    ! VARIABLES SECTION ---


    ! Looks for the given variable name in the NetCDF file and gets its
    ! dimensions.
    ! file: the SNCFile type to look in.
    ! varname: the name of the variable to inquire about.
    ! units: optional.  Reads the 'units' attribute into this
    ! argument.  expect: optional.  An array of integers giving the
    !   expected size of each variable dimension.  If these do not match
    !   the actual size of the variable, an error message will be
    !   printed and the program stopped.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_inq_var(file, varname, units, src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in) :: varname
        character(*), intent(out), optional :: units
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCVar) :: snc_inq_var
        character(700) :: err_msg
        integer :: status, i, dimids(4)

        snc_inq_var%name = varname

        write(err_msg, "('inquiring variable''s id ''',A,''' in ',A)") &
            trim(varname), trim(file%name)
        status = nf90_inq_varid(file%ncid, varname, snc_inq_var%id)
        call snc_handle_error(status, err_msg, src_file, src_line)

        write(err_msg, "('inquiring about variable ''',A,''' in ',A)") &
            trim(varname), trim(file%name)
        status = nf90_inquire_variable(file%ncid, snc_inq_var%id, &
            ndims = snc_inq_var%ndims, dimids = dimids)
        call snc_handle_error(status, err_msg, src_file, src_line)
        if (snc_inq_var%ndims > size(dimids)) then
            print "('Too many dimensions in variable ''',A,''' in ',A)", &
                trim(varname), trim(file%name)
            stop
        end if

        do i = 1, snc_inq_var%ndims
            write(err_msg, "('getting length for dimension ',I1,' of ''',A,''' in ',A)") &
                i, trim(varname), trim(file%name)
            call snc_handle_error(nf90_inquire_dimension(file%ncid, dimids(i), &
                len = snc_inq_var%dims(i)), err_msg, src_file, src_line)
        end do

        if (present(units)) call snc_get_att(file, snc_inq_var, "units", units)
    end function snc_inq_var

    ! Define a variable for the NetCDF file with the given name and type; the
    ! dimids are the values returned by snc_def_dim.
    ! file: the SNCFile type
    ! varname: the name for the new variable.
    ! vartype: One of: SNC_INT, SNC_FLOAT, SNC_DOUBLE. These match integers,
    !   single-precision real (real*4), and double-precision reals (real*8)
    !   respectively.
    ! dimids: determines the size of each dimension of the variable.  It is an
    !   array of dimension ID numbers.  These ID numbers are returned by
    !   snc_def_dim.  List these in the same order as you do in the Fortran
    !   variable declaration.
    ! def_lev: optional. If you are using NetCDF4, this overrides the default
    !   compression level.  The valid range is 1-9.  1 is fast but doesn't
    !   compress very much; 9 is slow but tries the hardest to compress the
    !   data.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    function snc_def_var(file, varname, vartype, dimids, deflate_lev, &
        src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in) :: varname
        integer, intent(in) :: vartype
        integer, intent(in), dimension(:) :: dimids
        integer, intent(in), optional :: def_lev
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCVar) :: snc_def_var
        character(700) :: err_msg
        integer :: i, ndims
#ifdef HAVE_NETCDF4
        integer :: level

        if (present(deflate_lev)) then
            level = deflate_lev
        else
            level = SNC_DEFAULT_DEFLATE
        end if
#endif

        write(err_msg, "('defining variable ''',A,''' in ',A)") trim(varname), trim(file%name)
        call snc_handle_error( &
            nf90_def_var(file%ncid, varname, vartype, dimids, snc_def_var%id &
#ifdef HAVE_NETCDF4
              , deflate_level = level &
#endif
            ), err_msg, src_file, src_line)
        snc_def_var%name = varname
        ndims = size(dimids)
        snc_def_var%ndims = ndims
        do i = 1, ndims
            snc_def_var%dims(i) = snc_get_dim(file, dimids(i), src_file, src_line)
        end do
    end function snc_def_var



    ! READ VAR SECTION ---

% (1..4).each do |n|
%   "ifd".each_char do |t|
    ! :nodoc:
    subroutine snc_read<%= n %><%= t %>(file, var, data, timestep, &
        src_file, src_line)
        type(SNCFile), intent(in) :: file
        type(SNCVar), intent(in) :: var
        <%= TYPE[t] %>, pointer :: data(<%= ([':'] * n).join(',') %>)
        integer, intent(in), optional :: timestep
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        integer, dimension(<%= n + 1 %>) :: start, count
        character(700) :: err_msg

        allocate(data(<%= (1..n).map {|i| "var%dims(#{i})"}.join(', ') %>))
        write(err_msg, "('reading <%= n %>d int variable ''',A,''' in ',A)") &
            trim(var%name), trim(file%name)

        if (present(timestep)) then
            if (var%ndims /= <%= n + 1 %>) stop "expected <%= n + 1 %> dimensional data array to read into"
            start(:<%= n %>) = 1
            start(<%= n + 1 %>) = timestep
            count(:<%= n %>) = var%dims(:<%= n %>)
            count(<%= n + 1 %>) = 1
            call snc_handle_error(nf90_get_var(file%ncid, var%id, data, &
                start, count), err_msg, src_file, src_line)
        else
            call snc_handle_error(nf90_get_var(file%ncid, var%id, data), &
                err_msg, src_file, src_line)
        end if
    end subroutine snc_read<%= n %><%= t %>


%   end

% end

    ! WRITE VAR SECTION ---

% (1..4).each do |n|
%   "ifd".each_char do |t|
    ! :nodoc:
    subroutine snc_write<%= n %><%= t %>(file, var, data, timestep, &
        src_file, src_line)
        type(SNCFile), intent(in) :: file
        type(SNCVar), intent(in) :: var
        <%= TYPE[t] %>, intent(in), dimension(<%= ([':'] * n).join(',') %>) :: data
        integer, intent(in), optional :: timestep
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        integer, dimension(<%= n + 1 %>) :: start, count
        character(700) :: err_msg
        integer :: status

        if (present(timestep)) then
            if (var%ndims /= <%= n + 1 %>) stop "expected <%= n + 1 %> dimensional data array to write from"
            start(:<%= n %>) = 1
            start(<%= n + 1 %>) = timestep
            count(:<%= n %>) = var%dims(:<%= n %>)
            count(<%= n + 1 %>) = 1
            status = nf90_put_var(file%ncid, var%id, data, start, count)
        else
            status = nf90_put_var(file%ncid, var%id, data)
        end if
        write(err_msg, "('writing <%= n %>d int variable ''',A,''' to ',A)") &
            trim(var%name), trim(file%name)
        call snc_handle_error(status, err_msg, src_file, src_line)
    end subroutine snc_write<%= n %><%= t %>


%   end

% end

    ! ATTRIBUTE SECTION ---

    ! Read an attribute from the NetCDF file

% %w(_str i f d).each do |t|
    ! :nodoc:
    subroutine snc_get_att<%= t %>(file, var, attname, attvalue, src_file, src_line)
        type(SNCFile), intent(in) :: file
        type(SNCVar), intent(in) :: var
        character(*), intent(in) :: attname
        <%= TYPE[t] %>, intent(out) :: attvalue
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        character(800) :: err_msg

        write(err_msg, "('getting <%= TYPE[t] %> attribute ''',A,':',A,''' in ',A)") &
            trim(var%name), trim(attname), trim(file%name)
        call snc_handle_error(nf90_get_att(file%ncid, var%id, attname, attvalue), &
            err_msg, src_file, src_line)
    end subroutine snc_get_att<%= t %>


    ! :nodoc:
    subroutine snc_get_gatt<%= t %>(file, attname, attvalue, src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in) :: attname
        <%= TYPE[t] %>, intent(out) :: attvalue
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCVar) :: var

        var%id = NF90_GLOBAL
        var%name = "(global)"
        call snc_get_att<%= t %>(file, var, attname, attvalue, src_file, src_line)
    end subroutine snc_get_gatt<%= t %>


% end


    ! Write an attribute to the NetCDF file.

% %w(_str i f d).each do |t|
    ! :nodoc:
    subroutine snc_put_att<%= t %>(file, var, attname, attvalue, src_file, src_line)
        type(SNCFile), intent(in) :: file
        type(SNCVar), intent(in) :: var
        character(*), intent(in) :: attname
        <%= TYPE[t] %>, intent(in) :: attvalue
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        character(700) :: err_msg

        write(err_msg, "('creating <%= TYPE[t] %> attribute ''',A,''' for variable ',A,' in ',A)") &
            trim(attname), trim(var%name), trim(file%name)
        call snc_handle_error(nf90_put_att(file%ncid, var%id, attname, attvalue), &
            err_msg, src_file, src_line)
    end subroutine snc_put_att<%= t %>


    ! :nodoc:
    subroutine snc_put_gatt<%= t %>(file, attname, attvalue, src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in) :: attname
        <%= TYPE[t] %>, intent(in) :: attvalue
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        type(SNCVar) :: var

        var%id = NF90_GLOBAL
        var%name = "(global)"
        call snc_put_att<%= t %>(file, var, attname, attvalue, src_file, src_line)
    end subroutine snc_put_gatt<%= t %>


% end


    ! Finish the NetCDF data definition and prepare for reading or writing.
    ! Call when you are ready to write variables to the file.
    ! file: the SNCFile type to put into data read/write mode.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    subroutine snc_enddef(file, src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        character(550) :: err_msg

        write(err_msg, "('Ending header definition for ',A)") trim(file%name)
        call snc_handle_error(nf90_enddef(file%ncid), err_msg, src_file, src_line)
    end subroutine snc_enddef

    ! Closes the NetCDF file after you are done reading from or writing to it.
    ! file: the SNCFile type to close.
    ! src_file: optional. The source file name to use when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    ! src_line: optional. The line number in the source file where this
    !   subroutine was called from.  Used when reporting errors.
    !   Usually automatically added when you #include <simple_netcdf.inc>.
    subroutine snc_close(file, src_file, src_line)
        type(SNCFile), intent(in) :: file
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line
        character(520) :: err_msg

        write(err_msg, "('closing ',A)") trim(file%name)
        call snc_handle_error(nf90_close(file%ncid), err_msg, src_file, src_line)
    end subroutine snc_close



    ! You will only use this subroutine if you call NetCDF functions directly.
    ! Checks the return status of a NetCDF function.  If there is an error,
    ! it prints the NetCDF error string, the error message if given, then
    ! stops the program.
    ! status: the integral status value returned by the NetCDF function.
    ! message: the message to print when an error occurs.  Usually used to
    !   explain the action that caused the error.
    ! src_file: optional.  The source file of the original, possibly erroneous
    !   NetCDF library call.  Include this for maximum debuggability, usually
    !   through a macro in simple_netcdf.inc which uses the C preprocessor
    !   define __FILE__.
    ! src_line: The source file line number of the original, possibly erroneous
    !   NetCDF library call.  Include this for maximum debuggability, usually
    !   through a macro in simple_netcdf.inc which uses the C preprocessor
    !   define __LINE__.
    subroutine snc_handle_error(status, message, src_file, src_line)
        integer, intent(in) :: status
        character(*), intent(in), optional :: message
        character(*), intent(in), optional :: src_file
        integer, intent(in), optional :: src_line

        if (status /= NF90_NOERR) then
            if (present(src_file) .and. present(src_line)) then
                write(*, "(A,' line',I5,': ',A)") &
                    src_file, src_line, trim(nf90_strerror(status))
            else
                print *, trim(nf90_strerror(status))
            end if
            if (present(message)) print "('   While: ',A)", trim(message)
            stop
        end if
    end subroutine snc_handle_error

end module SimpleNetCDF
